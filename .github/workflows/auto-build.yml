name: Test and Build

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
      - 'release-*'
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  test:
    name: Test (Main Branch)
    if: github.ref == 'refs/heads/main'
    runs-on: windows-latest
    defaults:
      run:
        shell: pwsh
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Miniconda
        uses: conda-incubator/setup-miniconda@v2
        with:
          auto-activate-base: false
          activate-environment: psychopy-dev
          environment-file: environment.yml
          use-mamba: true

      - name: Show Conda Info
        run: |
          conda info -e
          conda list

      - name: Run Tests
        run: |
          # Syntax check
          conda run -n psychopy-dev python -m py_compile src/run_raven.py
          Write-Host "✓ Syntax check passed" -ForegroundColor Green

          # Run unit tests
          conda run -n psychopy-dev python tests/test_raven_task.py
          Write-Host "✓ Unit tests passed" -ForegroundColor Green

  build-and-release:
    name: Build & Release (Tag)
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: windows-latest
    defaults:
      run:
        shell: pwsh
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Miniconda
        uses: conda-incubator/setup-miniconda@v2
        with:
          auto-activate-base: false
          activate-environment: psychopy-dev
          environment-file: environment.yml
          use-mamba: true

      - name: Show Conda Info
        run: |
          conda info -e
          conda list

      - name: Run Tests
        run: |
          # Syntax check
          conda run -n psychopy-dev python -m py_compile src/run_raven.py
          Write-Host "✓ Syntax check passed" -ForegroundColor Green

          # Run unit tests
          conda run -n psychopy-dev python tests/test_raven_task.py
          Write-Host "✓ Unit tests passed" -ForegroundColor Green

      - name: Build EXE with PyInstaller (onefile)
        run: |
          pwsh -File build_exe.ps1 -OneFile

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: RavenTask-${{ github.ref_name }}
          path: dist/RavenTask.exe

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          draft: false
          prerelease: false
          files: |
            dist/RavenTask.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
